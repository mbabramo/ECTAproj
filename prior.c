/* prior.c
 * 12 July 2000
 * prior generation
 */

#include <stdio.h>
        /* printf, sprintf      */
#include <stdlib.h>
        /* rand(), RAND_MAX     */
#include <math.h>
        /* floor()              */
#include <limits.h>
        /* INT_MAX,  INT_MIN    */

#include "prior.h"
                                  
#include "rat.h"
#include "rataux.h"	/* contfract()	*/
#include "treedef.h"
#include "sfnf.h"
	/* realplan[PLAYERS], behavtorealplan()	*/
#include "seqform.h"
	/* outbehavstrat	*/

/* generate the prior, stored in  moves[]->behavprob,
 * where each move has equal probability
 */ 
static void gencentroid(void)
{
    Move c;
    int pl;
    for (pl=1; pl < PLAYERS; pl++)
        for (c = firstmove[pl]+1; c < firstmove [pl+1]; c++)
            {
            c->behavprob.num = 1;
            c->behavprob.den = c->atiset->nmoves;
            }
}

// Make it possible to have predictable series of random numbers -- for debugging only. 
static int RandDebuggingMode = 1; // DEBUGX
static int RandDebuggingIndex = 0;
#define RandDebuggingTotal 1000
static double RandNums[RandDebuggingTotal] = { 0.57093,0.04351,0.10683,0.21573,0.46976,0.95347,0.25219,0.80208,0.25461,0.71108,0.33842,0.40057,0.71189,0.12997,0.7447,0.76698,0.46236,0.09272,0.66976,0.72175,0.83181,0.57792,0.18254,0.72391,0.49899,0.50533,0.17756,0.2092,0.05193,0.15968,0.46083,0.6745,0.10398,0.7443,0.74163,0.5077,0.84802,0.59178,0.78791,0.88328,0.72022,0.43067,0.8651,0.00503,0.79837,0.62926,0.06685,0.58658,0.60144,0.60647,0.90122,0.54036,0.19372,0.69091,0.411,0.99301,0.86097,0.38291,0.71674,0.96443,0.77591,0.04299,0.75015,0.09493,0.25025,0.66393,0.29659,0.9676,0.38834,0.237,0.91896,0.87058,0.30481,0.78648,0.00152,0.40114,0.71282,0.17751,0.92555,0.86973,0.43847,0.59097,0.60776,0.44546,0.25846,0.92047,0.48077,0.41307,0.3333,0.74862,0.64673,0.4651,0.87503,0.82348,0.10737,0.67723,0.68052,0.77017,0.75478,0.13444,0.33267,0.09926,0.19824,0.36444,0.68751,0.03064,0.23556,0.40724,0.68938,0.00986,0.28019,0.68346,0.45737,0.84701,0.52596,0.18494,0.43524,0.30469,0.83647,0.32978,0.18315,0.88352,0.6343,0.63973,0.59027,0.45385,0.99554,0.48133,0.67911,0.3243,0.72062,0.94265,0.42273,0.79111,0.53706,0.33921,0.39273,0.24332,0.75795,0.22783,0.68491,0.07353,0.72369,0.32344,0.46842,0.96327,0.00774,0.02802,0.29752,0.92243,0.24199,0.37583,0.9337,0.425,0.95129,0.44915,0.46496,0.55851,0.77418,0.23366,0.03509,0.75423,0.72813,0.36509,0.28923,0.33754,0.26073,0.66626,0.30995,0.18675,0.79221,0.19192,0.54674,0.60864,0.64487,0.10962,0.15983,0.31085,0.1713,0.627,0.44612,0.96752,0.18381,0.75668,0.0823,0.3448,0.00895,0.99772,0.83982,0.08791,0.87425,0.83422,0.46914,0.52429,0.19274,0.93069,0.3454,0.3586,0.03421,0.13088,0.70254,0.34148,0.71807,0.11077,0.13022,0.05007,0.82908,0.32506,0.78014,0.84167,0.28932,0.15411,0.38721,0.14718,0.78754,0.06757,0.57042,0.97145,0.28278,0.94443,0.32859,0.26301,0.82644,0.22204,0.31249,0.95799,0.72278,0.02245,0.4159,0.71418,0.76422,0.80122,0.27664,0.04042,0.92446,0.10464,0.24945,0.07304,0.62646,0.03223,0.51571,0.68389,0.21759,0.99815,0.79859,0.72015,0.44701,0.32196,0.73676,0.12517,0.36027,0.37396,0.07582,0.08978,0.80229,0.43952,0.51503,0.49603,0.79828,0.17224,0.32729,0.80664,0.90916,0.06595,0.07745,0.4881,0.87746,0.34679,0.22272,0.6829,0.81812,0.49738,0.34498,0.25055,0.42872,0.6447,0.04542,0.82829,0.42345,0.59234,0.51098,0.40082,0.28569,0.29074,0.35391,0.39026,0.72541,0.18687,0.23813,0.48494,0.58961,0.75343,0.27476,0.45423,0.70494,0.70908,0.77473,0.15163,0.9207,0.31049,0.84269,0.10021,0.09924,0.05386,0.30705,0.86289,0.02897,0.82527,0.66106,0.15759,0.3941,0.68674,0.07257,0.20593,0.66126,0.92647,0.52095,0.61842,0.71204,0.6872,0.7627,0.6906,0.10867,0.73779,0.09329,0.06469,0.22261,0.89076,0.54561,0.71965,0.86997,0.89379,0.9076,0.11297,0.74966,0.41077,0.30158,0.23183,0.98369,0.49102,0.36128,0.90014,0.52581,0.08054,0.09084,0.90287,0.68085,0.06883,0.79297,0.77848,0.18813,0.15632,0.43959,0.2335,0.54779,0.15209,0.99155,0.36145,0.96057,0.24236,0.64028,0.13822,0.27966,0.94141,0.28761,0.50031,0.77914,0.95961,0.45628,0.25049,0.62488,0.28911,0.63473,0.22102,0.32591,0.86256,0.16479,0.02813,0.64695,0.19042,0.38384,0.15379,0.09779,0.76713,0.53152,0.71366,0.4542,0.6741,0.56518,0.59756,0.41922,0.94013,0.27126,0.74133,0.85074,0.22306,0.62048,0.5844,0.79292,0.59053,0.12373,0.72125,0.61255,0.54248,0.15359,0.89902,0.52159,0.21857,0.90758,0.68524,0.98731,0.96342,0.7145,0.77015,0.85853,0.48649,0.04043,0.51252,0.4099,0.57396,0.04611,0.10505,0.39443,0.85872,0.83127,0.68475,0.01785,0.8934,0.37027,0.10285,0.24207,0.58039,0.2352,0.05642,0.06669,0.66259,0.54124,0.5553,0.61354,0.6325,0.19207,0.23562,0.76651,0.87994,0.61026,0.45579,0.22563,0.50111,0.8828,0.36425,0.18263,0.10796,0.1745,0.21897,0.54442,0.01868,0.32682,0.75383,0.71121,0.46884,0.88116,0.62819,0.8483,0.80473,0.44316,0.40692,0.72822,0.65808,0.70346,0.19594,0.94525,0.48513,0.89899,0.7774,0.38189,0.81049,0.33853,0.51449,0.24846,0.37548,0.45912,0.51675,0.0106,0.00602,0.92022,0.13411,0.40589,0.01623,0.51201,0.04801,0.33577,0.78741,0.84409,0.14469,0.75134,0.56388,0.38732,0.96178,0.43678,0.20334,0.72757,0.56755,0.79764,0.68686,0.419,0.69751,0.20897,0.3971,0.83708,0.73393,0.68015,0.81233,0.50537,0.33573,0.00972,0.36441,0.61759,0.84228,0.88452,0.30905,0.00103,0.71199,0.14607,0.65545,0.86017,0.15785,0.64103,0.75429,0.02606,0.81801,0.42316,0.37675,0.07771,0.04512,0.64791,0.89157,0.7191,0.32373,0.58702,0.22271,0.92514,0.00878,0.17916,0.77807,0.36786,0.52344,0.28203,0.50836,0.13497,0.38692,0.94629,0.54504,0.07726,0.12773,0.2023,0.01559,0.42147,0.14219,0.8267,0.26116,0.05647,0.45468,0.37104,0.01907,0.31077,0.3034,0.73461,0.46025,0.68783,0.11815,0.64531,0.29386,0.25526,0.6618,0.38391,0.99225,0.53283,0.368,0.28758,0.33672,0.87581,0.13267,0.61932,0.63914,0.87172,0.87812,0.29949,0.94999,0.84282,0.63232,0.4701,0.57691,0.49704,0.32586,0.16624,0.47046,0.63774,0.16008,0.46731,0.06447,0.78883,0.82179,0.82054,0.01683,0.74161,0.65243,0.28978,0.41546,0.74381,0.21005,0.48276,0.05347,0.85461,0.48997,0.38535,0.9238,0.83536,0.7319,0.14735,0.43265,0.00391,0.78462,0.61743,0.05551,0.64805,0.0684,0.79682,0.9294,0.49556,0.91346,0.35451,0.37275,0.90069,0.22312,0.54789,0.05402,0.31213,0.60249,0.89753,0.21929,0.58833,0.88403,0.20618,0.63277,0.14956,0.41663,0.7223,0.00706,0.94052,0.24244,0.63509,0.90584,0.01273,0.03466,0.06056,0.00421,0.20436,0.76503,0.36878,0.67321,0.8556,0.36039,0.9199,0.83035,0.85554,0.11001,0.15278,0.63149,0.94208,0.33132,0.61167,0.23287,0.83437,0.92806,0.84431,0.11988,0.57845,0.98466,0.90594,0.23142,0.3461,0.78976,0.98888,0.25313,0.27837,0.44868,0.36001,0.86603,0.16256,0.54368,0.84967,0.5471,0.23371,0.22432,0.36369,0.22795,0.96413,0.37582,0.77723,0.03955,0.26385,0.09081,0.06498,0.6092,0.63076,0.40222,0.07147,0.08468,0.19035,0.94067,0.42576,0.2197,0.85909,0.13736,0.32711,0.06584,0.37151,0.66677,0.55199,0.40686,0.75,0.28675,0.46893,0.3984,0.48165,0.06457,0.99916,0.61005,0.56437,0.61637,0.15575,0.20262,0.20742,0.86639,0.96757,0.25529,0.72478,0.37968,0.62236,0.87615,0.3772,0.27533,0.67569,0.22189,0.11792,0.62997,0.68802,0.09635,0.89721,0.29785,0.85644,0.29736,0.82384,0.37037,0.28956,0.9771,0.62187,0.66658,0.12754,0.56619,0.40306,0.46143,0.52031,0.57398,0.78492,0.22314,0.01228,0.9927,0.16979,0.07182,0.34106,0.99183,0.04441,0.67584,0.02966,0.47466,0.61106,0.24705,0.28048,0.85169,0.37655,0.90281,0.71284,0.26652,0.75993,0.85839,0.37879,0.83705,0.57683,0.99047,0.63342,0.0582,0.25214,0.05617,0.47308,0.91578,0.75503,0.10171,0.43697,0.89478,0.61769,0.69532,0.92656,0.82539,0.95679,0.86461,0.25296,0.148,0.34072,0.81489,0.36604,0.37483,0.3861,0.27586,0.18964,0.50026,0.74859,0.25379,0.81405,0.92653,0.84435,0.17523,0.41586,0.17932,0.4384,0.28286,0.73969,0.98824,0.20276,0.11388,0.71964,0.50935,0.81008,0.3857,0.234,0.68124,0.97624,0.88744,0.30973,0.89532,0.60543,0.23079,0.49633,0.76194,0.62443,0.25859,0.67211,0.97628,0.86653,0.97282,0.16719,0.50124,0.28766,0.51043,0.05043,0.44246,0.27945,0.74724,0.38699,0.67393,0.12492,0.26472,0.94524,0.22684,0.09526,0.85669,0.56475,0.0004,0.04186,0.50841,0.52402,0.86115,0.94406,0.91873,0.3211,0.61356,0.67889,0.65393,0.55489,0.17981,0.61075,0.76341,0.12171,0.22994,0.94669,0.2184,0.22169,0.29965,0.33527,0.79153,0.40178,0.22901,0.50045,0.6358,0.7704,0.34071,0.28555,0.26949,0.66668,0.76774,0.69384,0.6717,0.93442,0.35812,0.44881,0.30604,0.55718,0.36893,0.18933,0.43687,0.76357,0.62553,0.19235,0.20719,0.06318,0.36151,0.14301,0.7153,0.28015,0.87686,0.63499,0.2651,0.66513,0.25033,0.10662,0.29501,0.3607,0.30826,0.14833,0.9804,0.32801,0.4094,0.98725,0.78715,0.48597,0.93905,0.82899,0.76359,0.78113,0.64065,0.66122,0.85277,0.11032,0.8984,0.02796,0.77625,0.03666,0.29326,0.57262,0.4089,0.1977,0.57026,0.98934,0.78982,0.13275,0.42874,0.00657,0.6841,0.2515,0.1538,0.94534,0.24892,0.2206,0.20893,0.10886,0.35417,0.63828,0.4052,0.72122,0.12414,0.53252,0.37942,0.93416,0.6395,0.21564,0.78223,0.15478,0.76673,0.22236,0.33037,0.25835,0.06744,0.73564,0.73943,0.7827,0.75775,0.42006,0.19743,0.6544,0.05723,0.93248,0.14489,0.51209,0.62734,0.69531,0.4123,0.63216,0.90139,0.78955,0.6738 };
double randdoub()
{
	if (RandDebuggingMode)
	{
		if (RandDebuggingIndex == RandDebuggingTotal)
			RandDebuggingIndex = 0;
		return RandNums[RandDebuggingIndex++];
	}
	else
		return rand() / (double)RAND_MAX;
}

void genprior(Flagsprior flags)
{
    int pl;
    Iset h;

    if (0 == flags.seed)
	{
    	gencentroid();
	return ;
	}
    /* generate random priors for all information sets	*/
    srand(FIRSTPRIORSEED + flags.seed); 
    for (pl=1; pl < PLAYERS; pl++)
        for (h = firstiset[pl]; h < firstiset [pl+1]; h++)
	    if ( h->nmoves > 2)
	    	{
			// We must create fractions that add up to 1 (each greater than 0).
			// So, we'll just take random numbers from 1 to 10, use those for numerators
			// and the sum for a denominator.
			int denominator = 0;
			for (int i = 0; i < h->nmoves; i++)
			{
				double maxValue = 9;
				int numerator = 1 + floor(maxValue * randdoub()); 
				((h->move0) + i)->behavprob = ratfromi(numerator); // store value so that we remember it
				denominator += numerator;
			}
			for (int i = 0; i < h->nmoves; i++)
			{
				Rat a;
				a.num = ((h->move0) + i)->behavprob.num;
				a.den = denominator;
				((h->move0) + i)->behavprob = a;
			}
		//Original code:
		//fprintf(stderr, "Sorry, only binary info sets so far.\n") ; 
		//exit(1) ;
		}
            else 
                {
	        Rat a;
	        double x;

	        x = randdoub();
	        a = contfract( x, flags.accuracy) ;
	        /* make sure to get a properly mixed prior,
	         * unless  flags.accuracy == 1,
	  	 * in which case we have a random pure strategy
		 * because this statement flips 0 to 1 and vice versa
		 */
	        if (a.num == 0)
	            {
		    a.num = 1 ;
		    a.den = flags.accuracy;
		    }
                else if (a.den == 1)  	/* "else" for pure strategy	*/
	            {
		    a.num = flags.accuracy - 1 ;
		    a.den = flags.accuracy;
		    }
                h->move0->behavprob = a ;
                ((h->move0)+1)->behavprob = ratadd(ratfromi(1), ratneg(a)) ;
                }
}

void outprior(void)
{
    int pl;

    printf("------Prior behavior strategies player 1, 2:\n");
    for ( pl = 1; pl < PLAYERS; pl++ )
        {
	behavtorealprob(pl) ;
	realplanfromprob(pl, realplan[pl]);
	outbehavstrat(pl, realplan[pl], 1);
	}
}
